<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Performance for {{ student_name }}</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
    <header class="appbar">
        <div>Viewing Performance: <strong>{{ student_name }}</strong></div>
        <nav>
            <a href="{{ url_for('educator_dashboard') }}">Back to Dashboard</a>
            <a href="/logout">Logout</a>
        </nav>
    </header>
    <main class="container">
        <section class="card">
            <h2>Progress Over Time</h2>
            <canvas id="chart-progress" height="140"></canvas>
        </section>

        <section class="card">
            <h2>All Submissions by {{ student_name }}</h2>
            {% if submissions %}
                <ul class="list">
                    {% for s in submissions %}
                        <li>
                            <div class="muted">{{ s.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</div>
                            <div class="mono">{{ s.problem_description or 'No description available' }}</div>
                            <div>
                                <strong>Status:</strong> {{ 'Passed' if s.evaluation.pass else 'Failed' }}
                                • <strong>Score:</strong> {{ s.evaluation.score }}%
                            </div>
                            <a href="{{ url_for('view_submission', sid=s.id) }}">View Details</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="muted">This student has no submissions yet.</div>
            {% endif %}
        </section>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    (function(){
        let lineChart;
        function createChart(ctx, labels, data){
            if(lineChart) lineChart.destroy();
            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score (%)',
                        data: data,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79,70,229,0.2)',
                        tension: 0.2
                    }]
                },
                options: { scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        async function loadChartData(){
            // ⭐ FIX: Using the correct variable name 'student_name'
            const response = await fetch(`/api/educator/student/{{ student_name }}/performance`);
            if (!response.ok) return;
            
            const data = await response.json();
            const timeseries = data.timeseries || [];
            
            const labels = timeseries.map(point => new Date(point.t).toLocaleString());
            const scores = timeseries.map(point => point.score || 0);
            
            const ctx = document.getElementById('chart-progress').getContext('2d');
            createChart(ctx, labels, scores);
        }
        loadChartData();
    })();
    </script>
</body>
</html>