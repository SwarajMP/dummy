<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
    <header class="appbar">
        <div>Welcome, {{ name }}</div>
        <nav>
            <a href="/logout">Logout</a>
        </nav>
    </header>
    <main class="container">
        <section class="card">
            <h2>Join a Test</h2>
            <form method="post" action="/student/access">
                <label>Access Code</label>
                <input type="text" name="access_code" placeholder="Enter access code provided by educator" />
                <button type="submit">Access Test</button>
            </form>
        </section>
        <section class="card">
            <h2>Your Progress</h2>
            <canvas id="chart-timeseries" height="140"></canvas>
        </section>
        <section class="card">
            <h2>Your Submissions</h2>
            {% if submissions %}
                <ul class="list">
                    {% for s in submissions %}
                        <li>
                            <div class="muted">{{ s.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</div>
                            <div class="mono">{{ s.problem_description or 'No description available' }}</div>
                            {% if s.evaluation %}
                                <div>
                                    <strong>Status:</strong> {{ 'Passed' if s.evaluation.pass else 'Failed' }}
                                    • <strong>Score:</strong> {{ s.evaluation.score }}%
                                </div>
                                <details>
                                    <summary>AI Feedback</summary>
                                    <div class="mono">{{ s.evaluation.ai_feedback or 'Generating… (this updates automatically in a few seconds)' }}</div>
                                </details>

                                <!-- ⭐ FIX: This entire block is new. It displays the complexity. -->
                                {% if s.evaluation.complexity %}
                                <details>
                                    <summary>Time/Space Complexity Analysis</summary>
                                    <div class="mono">
                                        <strong>Time:</strong> {{ s.evaluation.complexity.time or 'N/A' }}<br>
                                        <strong>Space:</strong> {{ s.evaluation.complexity.space or 'N/A' }}<br>
                                        <em>{{ s.evaluation.complexity.rationale or 'No rationale provided.' }}</em>
                                    </div>
                                </details>
                                {% endif %}

                            {% else %}
                                <div class="muted">Pending evaluation</div>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="muted">No submissions yet.</div>
            {% endif %}
        </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    (function(){
        let lineChart;
        function mkLine(ctx, labels, data){
            if(lineChart) lineChart.destroy();
            lineChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Score (%)', data, borderColor: '#4f46e5', backgroundColor: 'rgba(79,70,229,0.2)', tension: 0.25 }]},
                options: { scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }
        async function load(){
            const res = await fetch('/api/student/me/performance');
            if (!res.ok) return;

            const data = await res.json();
            const ts = data.timeseries || [];
            
            const labels = ts.map(x => new Date(x.t).toLocaleString());
            const scores = ts.map(x => x.score || 0);

            mkLine(document.getElementById('chart-timeseries'), labels, scores);
        }
        load();
        setInterval(load, 10000);
    })();
    </script>
</body>
</html>